<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml" lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Аналитика заявок</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <link rel="stylesheet" th:href="@{/styles/statistic/all-statistic-styles.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<div class="container">
    <header th:insert="~{blocks/header :: header}"></header>

    <div class="header-container">
        <h2 class="mt-4">Аналитика заявок</h2>

        <div class="export-btn-container">
            <form th:action="@{/statistics/export/excel}" th:method="GET">
                <button type="submit" class="export-btn">
                    <i class="fas fa-file-excel"></i> Экспорт в Excel
                </button>
            </form>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <select id="chartSelector" class="form-select">
                <option value="toursChart">Заявки по турам</option>
                <option value="userActivityChart">Активность менеджера</option>
                <option value="countriesChart">Популярность по странам</option>
            </select>
        </div>
    </div>
    <div sec:authorize="hasAuthority('ADMIN')" class="row mb-4" id="managerSelectContainer" style="display: none;">
        <div class="col-md-4">
            <select id="managerSelect" class="form-select">
                <option value="">Выберите менеджера</option>
            </select>
        </div>
    </div>

    <div id="toursChartContainer" class="chart-container">
        <canvas id="toursChart"></canvas>
    </div>

    <div id="userActivityChartContainer" class="chart-container">
        <canvas id="userActivityChart"></canvas>
    </div>

    <div id="countriesChartContainer" class="chart-container">
        <canvas id="countriesChart"></canvas>
    </div>

    <footer th:insert="~{blocks/footer :: footer}"></footer>
</div>

<script th:inline="javascript">
    let managers = /*[[${managers}]]*/ [];
    let toursChartInstance;
    let userActivityChartInstance;
    let countriesChartInstance;

        async function initToursChart() {
        const response = await fetch('/api/statistics/tours');
        const tourStats = await response.json();

        const labels = tourStats.map(stat => stat.tourTitle);
        const data = tourStats.map(stat => stat.orderCount);

        let toursCtx = document.getElementById('toursChart').getContext('2d');
        if (toursChartInstance) {
            toursChartInstance.destroy();
        }

        toursChartInstance = new Chart(toursCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Количество заявок',
                    data: data,
                    backgroundColor: data.map(value => {
                        if (value < 3) return 'rgba(255, 99, 132, 0.7)';
                        else if (value >= 3 && value <= 6) return 'rgba(255, 206, 86, 0.7)';
                        else return 'rgba(75, 192, 192, 0.7)';
                    })
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'Заявки по турам',
                        font: { size: 16 }
                    }
                }
            }
        });
    }


async function initUserActivityChart(managerId = null) {
    let url = '/api/statistics/managers';
    if (managerId) {
        url += `?managerId=${managerId}`;
    }

    const response = await fetch(url);
    const monthlyStats = await response.json();

    const labels = monthlyStats.map(s => formatMonthName(s.month));
    const data = monthlyStats.map(s => s.count);

    const ctx = document.getElementById('userActivityChart').getContext('2d');
    if (userActivityChartInstance) userActivityChartInstance.destroy();

    userActivityChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Обработанные заявки',
                data: data,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderWidth: 2,
                fill: true,
                tension: 0.2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Активность менеджера по месяцам' }
            }
        }
    });
}

    function formatMonthName(monthYear) {
        const [month, year] = monthYear.split('/');
        const names = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                       'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
        return `${names[parseInt(month)-1]} ${year}`;
    }

    async function initCountriesChart() {
        const response = await fetch('/api/statistics/countries');
        const stats = await response.json();

        const labels = stats.map(s => s.countryName);
        const data = stats.map(s => s.count);

        let ctx = document.getElementById('countriesChart').getContext('2d');
        if (countriesChartInstance) countriesChartInstance.destroy();

        countriesChartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: data.map((_, i) => {
                        const colors = [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)'
                        ];
                        return colors[i % colors.length];
                    })
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: 'Популярность по странам' },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const total = data.reduce((a, b) => a + b, 0);
                                const percent = ((ctx.raw / total) * 100).toFixed(2);
                                return `${ctx.label}: ${ctx.raw} заявок (${percent}%)`;
                            }
                        }
                    },
                    datalabels: {
                        display: true,
                        formatter: (val, ctx) => {
                            const total = data.reduce((a, b) => a + b, 0);
                            return `${((val / total) * 100).toFixed(1)}%`;
                        },
                        color: '#fff'
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }


        // Вспомогательная функция для получения названия месяца
        function getMonthName(monthNum) {
            const months = [
                'Январь', 'Февраль', 'Март', 'Апрель',
                'Май', 'Июнь', 'Июль', 'Август',
                'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
            ];
            return months[parseInt(monthNum)-1];
        }

        // Функция для переключения между графиками
        function switchChart(selectedChart) {
            document.querySelectorAll('.chart-container').forEach(container => {
                container.classList.remove('active-chart');
            });
            document.getElementById(selectedChart + 'Container').classList.add('active-chart');
        }

        document.addEventListener('DOMContentLoaded', function () {
    initToursChart();
    initUserActivityChart();
    initCountriesChart();
    switchChart('toursChart');

    document.getElementById('chartSelector').addEventListener('change', function () {
        switchChart(this.value);
    });

    // Если админ — показать dropdown с менеджерами
    if (typeof managers !== 'undefined' && managers.length > 0) {
        populateManagerDropdown();

        document.getElementById('managerSelect').addEventListener('change', function () {
            const selectedManagerId = this.value;
            if (selectedManagerId) {
                initUserActivityChart(selectedManagerId);
            }
        });
    }
});


    function populateManagerDropdown() {
    const select = document.getElementById('managerSelect');
    if (!select) return;

    select.innerHTML = '<option value="">Выберите менеджера</option>';

    managers.forEach(manager => {
        const option = document.createElement('option');
        option.value = manager.id;
        option.textContent = `${manager.firstName} ${manager.lastName}`;
        select.appendChild(option);
    });

    // Покажем dropdown
    document.getElementById('managerSelectContainer').style.display = 'block';
}

</script>
</body>
</html>