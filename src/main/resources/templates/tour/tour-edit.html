<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="ru">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Редактирование тура | Антур</title>
    <link rel="stylesheet" th:href="@{/styles/tour/tour-edit-styles.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<div class="container py-4">
    <header th:insert="~{blocks/header :: header}"></header>

    <div class="edit-tour-container">
        <h3 class="form-title"><i class="fas fa-edit me-2"></i>Редактирование тура</h3>

        <form th:action="@{/tours/{id}(id=${tour.id})}" th:method="PUT" th:object="${tour}">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="hotelName" class="form-label">Отель</label>
                    <div class="input-group">
                        <select name="hotelName" class="form-select" id="hotelName" required>
                            <option th:each="el : ${hotels}"
                                    th:value="${el.name}"
                                    th:text="${el.name}"
                                    th:selected="${el.name == tour.hotel.name}"></option>
                        </select>
                        <button sec:authorize="hasAuthority('ADMIN')" type="button" class="btn btn-outline-secondary btn-add-hotel"
                                data-bs-toggle="modal" data-bs-target="#addHotelModal">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="invalid-feedback">Пожалуйста, выберите отель</div>
                </div>

                <div class="col-md-6">
                    <label for="title" class="form-label">Название тура</label>
                    <input type="text" name="title" class="form-control" id="title"
                           th:value="*{title}" placeholder="Введите название тура" required>
                    <div class="invalid-feedback">Введите название тура</div>
                </div>

                <div class="col-12">
                    <label for="description" class="form-label">Описание</label>
                    <textarea name="description" class="form-control" id="description" rows="3" required
                              th:text="*{description}"></textarea>
                    <div class="invalid-feedback">Введите описание тура</div>
                </div>

                <div class="col-md-6">
                    <label for="countryName" class="form-label">Страна</label>
                    <select name="countryName" class="form-select" id="countryName" required>
                        <option th:each="el : ${countries}"
                                th:value="${el.name}"
                                th:text="${el.name}"
                                th:selected="${el.name == tour.country.name}"></option>
                    </select>
                    <div class="invalid-feedback">Выберите страну</div>
                </div>

                <div class="col-md-6">
                    <label for="price" class="form-label">Стоимость (руб)</label>
                    <div class="input-group">
                        <input type="number" step="0.01" name="price" class="form-control" id="price"
                               th:value="*{price}" required min="0" max="1000000">
                        <span class="input-group-text">Br</span>
                    </div>
                    <div class="invalid-feedback">Укажите стоимость</div>
                </div>

                <div class="col-md-6">
                    <label for="placeQuantity" class="form-label">Количество мест</label>
                    <input type="number" name="placeQuantity" class="form-control" id="placeQuantity"
                           th:value="*{placeQuantity}" required min="1" max="15">
                    <div class="invalid-feedback">Укажите количество мест (1-15)</div>
                </div>

                <div class="col-md-6">
                    <label for="startDate" class="form-label">Дата начала</label>
                    <input type="date" name="checkInDate" class="form-control" id="startDate"
                           th:value="*{#temporals.format(checkInDate, 'yyyy-MM-dd')}" required>
                    <div class="invalid-feedback">Выберите дату начала</div>
                </div>

                <div class="col-md-6">
                    <label for="endDate" class="form-label">Дата окончания</label>
                    <input type="date" name="checkOutDate" class="form-control" id="endDate"
                           th:value="*{#temporals.format(checkOutDate, 'yyyy-MM-dd')}" required>
                    <div class="invalid-feedback">Выберите дату окончания</div>
                </div>

                <div sec:authorize="hasAuthority('ADMIN')" class="col-12">
                    <div class="assignment-columns">
                        <!-- Колонка с менеджерами -->
                        <div class="assignment-column">
                            <h5><i class="fas fa-users me-2"></i>Менеджеры</h5>
                            <div class="assignment-list">
                                <div th:each="manager : ${managers}" class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           th:id="'manager-' + ${manager.id}"
                                           th:name="managerIds"
                                           th:value="${manager.id}"
                                           th:checked="${manager.isAssigned()}">
                                    <label class="form-check-label" th:for="'manager-' + ${manager.id}"
                                           th:text="${manager.fullName}">
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Колонка с тегами -->
                        <div class="assignment-column">
                            <h5><i class="fas fa-tags me-2"></i>Теги</h5>
                            <div class="assignment-list">
                                <div th:each="tag : ${tags}" class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           th:id="'tag-' + ${tag.id}"
                                           th:name="tagIds"
                                           th:value="${tag.id}"
                                           th:checked="${tag.isAssigned()}">
                                    <label class="form-check-label" th:for="'tag-' + ${tag.id}"
                                           th:text="${tag.name}">
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 mt-4">
                    <button class="btn btn-submit w-100 py-2" type="submit">
                        <i class="fas fa-save me-2"></i>Сохранить изменения
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="addHotelModal" tabindex="-1" aria-hidden="true">
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const countrySelect = document.getElementById('countryName');
        if (countrySelect) {
            countrySelect.addEventListener('change', function() {
                const country = this.value;
                const hotelSelect = document.getElementById('hotelName');

                fetch(`/hotels/${country}`)
                    .then(response => response.json())
                    .then(hotels => {
                        const currentHotel = hotelSelect.value;
                        hotelSelect.innerHTML = '';
                        hotels.forEach(hotel => {
                            const option = document.createElement('option');
                            option.value = hotel.name;
                            option.textContent = hotel.name;
                            hotelSelect.appendChild(option);
                        });
                        if (currentHotel) {
                            hotelSelect.value = currentHotel;
                        }
                    });
            });

            countrySelect.dispatchEvent(new Event('change'));
        }

        const startDate = document.getElementById('startDate');
        const endDate = document.getElementById('endDate');

        if (startDate && endDate) {
            startDate.addEventListener('change', function() {
                if (this.value && endDate.value && this.value > endDate.value) {
                    endDate.value = '';
                }
                endDate.min = this.value;
            });

            endDate.addEventListener('change', function() {
                if (this.value && startDate.value && this.value < startDate.value) {
                    this.setCustomValidity('Дата окончания должна быть после даты начала');
                } else {
                    this.setCustomValidity('');
                }
            });
        }
    });
</script>
</body>
</html>