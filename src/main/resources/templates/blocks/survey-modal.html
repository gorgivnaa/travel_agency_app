<div th:fragment="survey-modal">
    <link rel="stylesheet" th:href="@{/styles/blocks/survey-modal-styles.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <div class="modal fade" id="surveyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog survey-modal">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-clipboard-list me-2"></i>Анкета туристических предпочтений
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="preferenceForm" th:action="@{/survey/submit}" method="POST">
                    <div class="modal-body">
                        <div class="progress mb-4">
                            <div id="surveyProgress" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                        </div>

                        <!-- Вопрос 1: Тип отдыха -->
                        <div class="survey-question" id="q1">
                            <h4><span class="badge bg-primary me-2">1/6</span> Предпочитаемый тип отдыха</h4>
                            <div class="options mt-3">
                                <label class="option-card d-block">
                                    <input type="radio" name="purpose" value="Пляжный отдых,Релакс,Море">
                                    <i class="fas fa-umbrella-beach me-2"></i> Пляжный отдых
                                </label>
                                <label class="option-card d-block">
                                    <input type="radio" name="purpose" value="Горнолыжный курорт,Трекинг">
                                    <i class="fas fa-mountain me-2"></i> Активный отдых (горные лыжи, трекинг)
                                </label>
                                <label class="option-card d-block">
                                    <input type="radio" name="purpose" value="Гастрономия,Вино,Экскурсия">
                                    <i class="fas fa-utensils me-2"></i> Гастрономический туризм
                                </label>
                                <label class="option-card d-block">
                                    <input type="radio" name="purpose" value="Семейный,Все включено">
                                    <i class="fas fa-home me-2"></i> Семейный отдых
                                </label>
                            </div>
                        </div>

                        <!-- Вопрос 2: Бюджет -->
                        <div class="survey-question" id="q2" style="display:none;">
                            <h4><span class="badge bg-primary me-2">2/6</span> Бюджет на поездку</h4>
                            <div class="options mt-3">
                                <label class="option-card d-block">
                                    <input type="radio" name="budget" value="Не нужна виза">
                                    <i class="fas fa-euro-sign me-2"></i> Экономный (до 1000€ на человека)
                                </label>
                                <label class="option-card d-block">
                                    <input type="radio" name="budget" value="">
                                    <i class="fas fa-euro-sign me-2"></i> Стандартный (1000-2000€ на человека)
                                </label>
                                <label class="option-card d-block">
                                    <input type="radio" name="budget" value="Люкс">
                                    <i class="fas fa-euro-sign me-2"></i> Премиум (2000-5000€ на человека)
                                </label>
                                <label class="option-card d-block">
                                    <input type="radio" name="budget" value="Нужна виза">
                                    <i class="fas fa-euro-sign me-2"></i> VIP (неограниченный бюджет)
                                </label>
                            </div>
                        </div>

                        <!-- Вопрос 3: Сезон -->
                        <div class="survey-question" id="q3" style="display:none;">
                            <h4><span class="badge bg-primary me-2">3/6</span> Предпочитаемый сезон для путешествия</h4>
                            <div class="options mt-3">
                                <label class="option-card d-block">
                                    <input type="radio" name="season" value="Пляжный отдых,Море">
                                    <i class="fas fa-sun me-2"></i> Лето (июнь-август)
                                </label>
                                <label class="option-card d-block">
                                    <input type="radio" name="season" value="Горнолыжный курорт">
                                    <i class="fas fa-snowflake me-2"></i> Зима (декабрь-февраль)
                                </label>
                                <label class="option-card d-block">
                                    <input type="radio" name="season" value="Экскурсия">
                                    <i class="fas fa-leaf me-2"></i> Межсезонье (весна/осень)
                                </label>
                                <label class="option-card d-block">
                                    <input type="radio" name="season" value="Не нужна виза">
                                    <i class="fas fa-calendar-alt me-2"></i> Не имеет значения
                                </label>
                            </div>
                        </div>

                        <!-- Вопрос 4: Активность -->
                        <div class="survey-question" id="q4" style="display:none;">
                            <h4><span class="badge bg-primary me-2">4/6</span> Уровень активности во время отдыха</h4>
                            <div class="options mt-3">
                                <label class="option-card d-block">
                                    <input type="radio" name="pace" value="Релакс,Все включено">
                                    <i class="fas fa-couch me-2"></i> Спокойный отдых (отель, пляж)
                                </label>
                                <label class="option-card d-block">
                                    <input type="radio" name="pace" value="Экскурсия">
                                    <i class="fas fa-monument me-2"></i> Умеренный (экскурсии, прогулки)
                                </label>
                                <label class="option-card d-block">
                                    <input type="radio" name="pace" value="Трекинг">
                                    <i class="fas fa-hiking me-2"></i> Активный (походы, спорт)
                                </label>
                                <label class="option-card d-block">
                                    <input type="radio" name="pace" value="Гастрономия,Вино">
                                    <i class="fas fa-wine-glass-alt me-2"></i> Гастрономический (рестораны, дегустации)
                                </label>
                            </div>
                        </div>

                        <!-- Вопрос 5: Состав группы -->
                        <div class="survey-question" id="q5" style="display:none;">
                            <h4><span class="badge bg-primary me-2">5/6</span> Состав туристической группы</h4>
                            <div class="options mt-3">
                                <label class="option-card d-block">
                                    <input type="radio" name="company" value="Семейный">
                                    <i class="fas fa-users me-2"></i> Семья с детьми
                                </label>
                                <label class="option-card d-block">
                                    <input type="radio" name="company" value="Пляжный отдых,Релакс">
                                    <i class="fas fa-heart me-2"></i> Пара/романтический отдых
                                </label>
                                <label class="option-card d-block">
                                    <input type="radio" name="company" value="Горнолыжный курорт,Трекинг">
                                    <i class="fas fa-user-friends me-2"></i> Компания друзей
                                </label>
                                <label class="option-card d-block">
                                    <input type="radio" name="company" value="Экскурсия,Гастрономия">
                                    <i class="fas fa-user me-2"></i> Индивидуальное путешествие
                                </label>
                            </div>
                        </div>

                        <!-- Вопрос 6: Виза -->
                        <div class="survey-question" id="q6" style="display:none;">
                            <h4><span class="badge bg-primary me-2">6/6</span> Отношение к визовым требованиям</h4>
                            <div class="options mt-3">
                                <label class="option-card d-block">
                                    <input type="radio" name="visa" value="Не нужна виза">
                                    <i class="fas fa-check-circle me-2"></i> Только безвизовые направления
                                </label>
                                <label class="option-card d-block">
                                    <input type="radio" name="visa" value="Нужна виза">
                                    <i class="fas fa-globe-europe me-2"></i> Готов(а) оформлять визу
                                </label>
                                <label class="option-card d-block">
                                    <input type="radio" name="visa" value="">
                                    <i class="fas fa-question-circle me-2"></i> Не имеет значения
                                </label>
                                <label class="option-card d-block">
                                    <input type="radio" name="visa" value="Люкс">
                                    <i class="fas fa-gem me-2"></i> VIP-направления (независимо от визового режима)
                                </label>
                            </div>
                        </div>

                        <input type="hidden" id="selectedTags" name="tags">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" id="prevBtn" style="display:none;">
                            <i class="fas fa-arrow-left me-1"></i> Назад
                        </button>
                        <button type="button" class="btn btn-primary" id="nextBtn">
                            Далее <i class="fas fa-arrow-right ms-1"></i>
                        </button>
                        <button type="submit" class="btn btn-success" id="submitBtn" style="display:none;">
                            <i class="fas fa-paper-plane me-1"></i> Отправить анкету
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
    <script>
        // JavaScript код остается без изменений
        document.addEventListener('DOMContentLoaded', function() {
            const surveyBtn = document.querySelector('.survey-btn');
            const surveyModal = new bootstrap.Modal(document.getElementById('surveyModal'));

            if (surveyBtn) {
                surveyBtn.addEventListener('click', function() {
                    surveyModal.show();
                });
            }

            let currentQuestion = 1;
            const totalQuestions = 6;
            const progressBar = document.getElementById('surveyProgress');

            function updateProgress() {
                const progress = (currentQuestion / totalQuestions) * 100;
                progressBar.style.width = `${progress}%`;
                progressBar.setAttribute('aria-valuenow', progress);
            }

            document.getElementById('nextBtn').addEventListener('click', function() {
                if (validateQuestion(currentQuestion)) {
                    document.getElementById('q' + currentQuestion).style.display = 'none';
                    currentQuestion++;

                    if (currentQuestion <= totalQuestions) {
                        document.getElementById('q' + currentQuestion).style.display = 'block';
                        document.getElementById('prevBtn').style.display = 'inline-block';

                        if (currentQuestion === totalQuestions) {
                            this.style.display = 'none';
                            document.getElementById('submitBtn').style.display = 'inline-block';
                        }

                        updateProgress();
                    }
                }
            });

            document.getElementById('prevBtn').addEventListener('click', function() {
                document.getElementById('q' + currentQuestion).style.display = 'none';
                currentQuestion--;
                document.getElementById('q' + currentQuestion).style.display = 'block';

                if (currentQuestion === 1) {
                    this.style.display = 'none';
                }

                document.getElementById('nextBtn').style.display = 'inline-block';
                document.getElementById('submitBtn').style.display = 'none';

                updateProgress();
            });

            function validateQuestion(questionNum) {
                const questionDiv = document.getElementById('q' + questionNum);
                const selectedOption = questionDiv.querySelector('input[type="radio"]:checked');

                if (!selectedOption) {
                    alert('Пожалуйста, выберите один из вариантов ответа');
                    return false;
                }
                return true;
            }

            const optionCards = document.querySelectorAll('.option-card');
            optionCards.forEach(card => {
                card.addEventListener('click', function() {
                    const allOptions = this.closest('.options').querySelectorAll('.option-card');
                    allOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio) radio.checked = true;
                });
            });

            document.getElementById('preferenceForm').addEventListener('submit', function(e) {
                e.preventDefault();

                const allSelectedValues = [];
                const radioGroups = ['purpose', 'budget', 'season', 'pace', 'company', 'visa'];

                radioGroups.forEach(group => {
                    const selected = document.querySelector(`input[name="${group}"]:checked`);
                    if (selected && selected.value) {
                        allSelectedValues.push(selected.value);
                    }
                });

                const allTags = allSelectedValues.join(',').split(',');
                const uniqueTags = [...new Set(allTags)].filter(tag => tag.trim() !== '');

                document.getElementById('selectedTags').value = uniqueTags.join(',');
                this.submit();
            });
        });
    </script>
</div>